  
![](reference/figures/compartmap_logo.png)

*Chromatin compartment inference from single-cell RNA- and ATAC-seq*

Compartmap extends methods proposed by [Fortin and Hansen 2015, Genome
Biology](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-015-0741-y)
to perform direct inference of higher-order chromatin in *single cells*
from scRNA-seq and scATAC-seq. Originally, Fortin and Hansen
demonstrated that chromatin conformation could be inferred from
(sc)ATAC-seq, bisulfite sequencing, DNase-seq and methylation arrays,
similar to the results provided by HiC at the group level. Thus, in
addition to the base information provided by the aforementioned assays,
chromatin state could also be inferred.

Here, we propose a method to infer both group and single-cell level
higher-order chromatin states from scRNA-seq and scATAC-seq. To
accomplish this, we employ a James-Stein estimator (JSE) towards a
global or targeted mean, using either chromsome or genome-wide
information from scRNA-seq and scATAC-seq. Additionally, due to the
sparsity of single-cell data, we employ a bootstrap procedure to
quantify the uncertainty associated with the state and boundaries of
inferred compartments. The output from compartmap can then be visualized
directly, compared with orthogonal assay types, and/or embedded with
something like UMAP or t-SNE. Further, to explore the higher-order
interacting domains inferred from compartmap, we use a Random Matrix
Theory (RMT) approach to resolve the “plaid-like” patterning, similar to
what is observed in Hi-C and scHi-C.

## Installation

### Bioconductor

    # requires BiocManager
    install.packages("BiocManager")

    # Release
    BiocManager::install("compartmap")

    # Development
    install.packages("BiocManager")
    BiocManager::install("huishenlab/compartmap")

### GitHub

You can install the development version from Github by cloning the repo
and running

``` bash
git clone https://github.com/huishenlab/compartmap
R CMD INSTALL compartmap
```

You can also use
[`BiocManager`](https://bioconductor.github.io/BiocManager/),
[`devtools`](https://devtools.r-lib.org/) or
[`pak`](https://pak.r-lib.org/):

``` r
BiocManager::install("huishenlab/compartmap")

devtools::install_github("huishenlab/compartmap")

pak::pkg_install("huishenlab/compartmap")
```

### Usage

A user guide is available on the [package
website](https://huishenlab.github.io/compartmap). Bug reports may be
submitted through GitHub issues.

# Package index

## Compartment mapping

- [`scCompartments()`](https://huishenlab.github.io/compartmap/dev/reference/scCompartments.md)
  : Estimate A/B compartments from single-cell RNA or ATAC sequencing
  data
- [`arrayCompartments()`](https://huishenlab.github.io/compartmap/dev/reference/arrayCompartments.md)
  : Estimate A/B compartments from methylation array data

## Compartment helper

- [`filterCompartments()`](https://huishenlab.github.io/compartmap/dev/reference/filterCompartments.md)
  : Filter compartments using confidence estimates and eigenvalue
  thresholds
- [`fixCompartments()`](https://huishenlab.github.io/compartmap/dev/reference/fixCompartments.md)
  : Invert, or "fix", compartments that have a minimum confidence score
  (1-min.conf)
- [`extractOpenClosed()`](https://huishenlab.github.io/compartmap/dev/reference/extractOpenClosed.md)
  : Get the open and closed compartment calls based on sign of singular
  values
- [`getABSignal()`](https://huishenlab.github.io/compartmap/dev/reference/getABSignal.md)
  : Calculate Pearson correlations of smoothed eigenvectors

## Correlation matrix

- [`estRMT()`](https://huishenlab.github.io/compartmap/dev/reference/estRMT.md)
  : Denoising of Covariance matrix using Random Matrix Theory
- [`getCorMatrix()`](https://huishenlab.github.io/compartmap/dev/reference/getCorMatrix.md)
  : Calculate Pearson correlations of a binned matrix
- [`getDenoisedCorMatrix()`](https://huishenlab.github.io/compartmap/dev/reference/getDenoisedMatrix.md)
  : Wrapper to denoise a correlation matrix using a Random Matrix Theory
  approach

## Data transformation

- [`transformTFIDF()`](https://huishenlab.github.io/compartmap/dev/reference/transformTFIDF.md)
  : Transform/normalize counts using TF-IDF
- [`hdf5TFIDF()`](https://huishenlab.github.io/compartmap/dev/reference/hdf5TFIDF.md)
  : Transform/normalize compartment calls using TF-IDF on HDF5-backed
  objects

## Bootstrapping

- [`precomputeBootstrapMeans()`](https://huishenlab.github.io/compartmap/dev/reference/precomputeBootstrapMeans.md)
  : Pre-compute the global means for bootstrapping compartments
- [`bootstrapCompartments()`](https://huishenlab.github.io/compartmap/dev/reference/bootstrapCompartments.md)
  : Non-parametric bootstrapping of compartments and summarization of
  bootstraps/compute confidence intervals
- [`summarizeBootstraps()`](https://huishenlab.github.io/compartmap/dev/reference/summarizeBootstraps.md)
  : Summarize the bootstrap compartment estimates and compute
  Agresti-Coull confidence intervals

## Data import

- [`importBigWig()`](https://huishenlab.github.io/compartmap/dev/reference/importBigWig.md)
  : Import and optionally summarize a bigwig at a given resolution
- [`filterOpenSea()`](https://huishenlab.github.io/compartmap/dev/reference/filterOpenSea.md)
  : Filter to open sea CpG loci
- [`getOpenSeas()`](https://huishenlab.github.io/compartmap/dev/reference/getOpenSeas.md)
  : Gather open sea CpG from a GRanges of CpG islands
- [`preprocessArrays()`](https://huishenlab.github.io/compartmap/dev/reference/preprocessArrays.md)
  : Preprocess arrays for compartment inference

## Bioconductor helpers

- [`condenseRE()`](https://huishenlab.github.io/compartmap/dev/reference/condenseRE.md)
  : Condense a RaggedExperiment to a list of SummarizedExperiments
- [`condenseSE()`](https://huishenlab.github.io/compartmap/dev/reference/condenseSE.md)
  : Condense the output of condenseRE to reconstruct per-sample GRanges
  objects to plot
- [`getAssayNames()`](https://huishenlab.github.io/compartmap/dev/reference/getAssayNames.md)
  : Get the assay names from a SummarizedExperiment object
- [`getSeqLengths()`](https://huishenlab.github.io/compartmap/dev/reference/getSeqLengths.md)
  : Get the seqlengths of a chromosome from a given genome's GRanges
- [`getChrs()`](https://huishenlab.github.io/compartmap/dev/reference/getChrs.md)
  : Get the chromosomes from an object

## Stat functions

- [`agrestiCoullCI()`](https://huishenlab.github.io/compartmap/dev/reference/agrestiCoullCI.md)
  : Agresti-Coull confidence interval for a binomial proportion
- [`fexpit()`](https://huishenlab.github.io/compartmap/dev/reference/fexpit.md)
  : Helper function: expanded expit
- [`fisherZ()`](https://huishenlab.github.io/compartmap/dev/reference/fisherZ.md)
  : Fisher's Z transformation
- [`flogit()`](https://huishenlab.github.io/compartmap/dev/reference/flogit.md)
  : Helper function: squeezed logit
- [`getBinMatrix()`](https://huishenlab.github.io/compartmap/dev/reference/getBinMatrix.md)
  : Generate bins for A/B compartment estimation
- [`getDomainInflections()`](https://huishenlab.github.io/compartmap/dev/reference/getDomainInflections.md)
  : A wrapper function to generate a GRanges object of chromatin domain
  inflection points
- [`getGlobalMeans()`](https://huishenlab.github.io/compartmap/dev/reference/getGlobalMeans.md)
  : Get the global means of a matrix
- [`getMatrixBlocks()`](https://huishenlab.github.io/compartmap/dev/reference/getMatrixBlocks.md)
  : Get chunked sets of row-wise or column-wise indices of a matrix
- [`getSVD()`](https://huishenlab.github.io/compartmap/dev/reference/getSVD.md)
  : Compute the SVD of a matrix using irlba
- [`getShrinkageTargets()`](https://huishenlab.github.io/compartmap/dev/reference/getShrinkageTargets.md)
  : Get the specified samples to shrink towards instead of the global
  mean
- [`ifisherZ()`](https://huishenlab.github.io/compartmap/dev/reference/ifisherZ.md)
  : Inverse Fisher's Z transformation
- [`imputeKNN()`](https://huishenlab.github.io/compartmap/dev/reference/imputeKNN.md)
  : Impute missing values/NAs with KNN
- [`meanSmoother()`](https://huishenlab.github.io/compartmap/dev/reference/meanSmoother.md)
  : Windowed mean smoother
- [`precomputeBootstrapMeans()`](https://huishenlab.github.io/compartmap/dev/reference/precomputeBootstrapMeans.md)
  : Pre-compute the global means for bootstrapping compartments
- [`preprocessArrays()`](https://huishenlab.github.io/compartmap/dev/reference/preprocessArrays.md)
  : Preprocess arrays for compartment inference
- [`removeEmptyBoots()`](https://huishenlab.github.io/compartmap/dev/reference/removeEmptyBoots.md)
  : Remove bootstrap estimates that failed
- [`scCompartments()`](https://huishenlab.github.io/compartmap/dev/reference/scCompartments.md)
  : Estimate A/B compartments from single-cell RNA or ATAC sequencing
  data
- [`shrinkBins()`](https://huishenlab.github.io/compartmap/dev/reference/shrinkBins.md)
  : Employ an eBayes shrinkage approach for bin-level estimates for A/B
  inference
- [`sparseToDenseMatrix()`](https://huishenlab.github.io/compartmap/dev/reference/sparseToDenseMatrix.md)
  : Convert a sparse matrix to a dense matrix in a block-wise fashion

## Plotting

- [`plotAB()`](https://huishenlab.github.io/compartmap/dev/reference/plotAB.md)
  : Plots A/B compartment estimates on a per chromosome basis
- [`plotCorMatrix()`](https://huishenlab.github.io/compartmap/dev/reference/plotCorMatrix.md)
  : Plot a denoised correlation matrix

## Helpers

- [`cleanAssayCols()`](https://huishenlab.github.io/compartmap/dev/reference/cleanAssayCols.md)
  :

  Remove columns/cells/samples with NAs exceeding a threshold. See
  [`cleanAssay()`](https://huishenlab.github.io/compartmap/dev/reference/cleanAssay.md)

- [`cleanAssayRows()`](https://huishenlab.github.io/compartmap/dev/reference/cleanAssayRows.md)
  :

  Remove rows with NAs exceeding a threshold. See
  [`cleanAssay()`](https://huishenlab.github.io/compartmap/dev/reference/cleanAssay.md)

- [`.n_approx()`](https://huishenlab.github.io/compartmap/dev/reference/dot-n_approx.md)
  : n_tilde in AC

- [`.p_approx()`](https://huishenlab.github.io/compartmap/dev/reference/dot-p_approx.md)
  : p_tilde in AC

- [`.z()`](https://huishenlab.github.io/compartmap/dev/reference/dot-z.md)
  : Normal alpha/2 quantile

## Datasets

- [`array_data_chr14`](https://huishenlab.github.io/compartmap/dev/reference/array.data.chr14.md)
  : Example Illumina 450k methylation array data for compartmap
- [`hg19.gr`](https://huishenlab.github.io/compartmap/dev/reference/hg19.gr.md)
  : hg19 seqlengths as a GRanges object
- [`hg19.tx.gr`](https://huishenlab.github.io/compartmap/dev/reference/hg19.tx.gr.md)
  : hg19 genes as a GRanges object
- [`hg38.gr`](https://huishenlab.github.io/compartmap/dev/reference/hg38.gr.md)
  : hg38 seqlengths as a GRanges object
- [`hg38.tx.gr`](https://huishenlab.github.io/compartmap/dev/reference/hg38.tx.gr.md)
  : hg38 genes as a GRanges object
- [`k562_scatac_chr14`](https://huishenlab.github.io/compartmap/dev/reference/k562_scatac_chr14.md)
  : Example scATAC-seq data for compartmap
- [`k562_scrna_chr14`](https://huishenlab.github.io/compartmap/dev/reference/k562_scrna_chr14.md)
  : Example scRNA-seq data for compartmap
- [`k562_scrna_raw`](https://huishenlab.github.io/compartmap/dev/reference/k562_scrna_se_chr14.md)
  : Example scRNA-seq data for compartmap
- [`mm10.gr`](https://huishenlab.github.io/compartmap/dev/reference/mm10.gr.md)
  : mm10 seqlengths as a GRanges object
- [`mm10.tx.gr`](https://huishenlab.github.io/compartmap/dev/reference/mm10.tx.gr.md)
  : mm10 genes as a GRanges object
- [`mm9.gr`](https://huishenlab.github.io/compartmap/dev/reference/mm9.gr.md)
  : mm9 seqlengths as a GRanges object
- [`mm9.tx.gr`](https://huishenlab.github.io/compartmap/dev/reference/mm9.tx.gr.md)
  : mm9 genes as a GRanges object
- [`openSeas.hg19`](https://huishenlab.github.io/compartmap/dev/reference/openSeas.hg19.md)
  : hg19 open sea CpG as a GRanges object
- [`openSeas.hg38`](https://huishenlab.github.io/compartmap/dev/reference/openSeas.hg38.md)
  : hg38 open sea CpG as a GRanges object
- [`openSeas.mm10`](https://huishenlab.github.io/compartmap/dev/reference/openSeas.mm10.md)
  : mm10 open sea CpG as a GRanges object
- [`openSeas.mm9`](https://huishenlab.github.io/compartmap/dev/reference/openSeas.mm9.md)
  : mm9 open sea CpG as a GRanges object
- [`ss3_umi_sce`](https://huishenlab.github.io/compartmap/dev/reference/ss3_umi_sce.md)
  : Example SMART-seq3 scRNA-seq data for compartmap

# Articles

### All vignettes

- [Direct inference of higher-order chromatin structure in individual
  cells from scRNA-seq and scATAC-seq with
  compartmap](https://huishenlab.github.io/compartmap/dev/articles/compartmap.md):
